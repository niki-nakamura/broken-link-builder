# BLB v2 — 実装タスクリスト

`specs/001-update-blb-v2-spec/spec.md` 及び `plans/001-blb-v2/plan.md` に基づく実装タスク。

## Phase 1: 設定と基盤 (Setup & Foundation)

-   [ ] T001 `src/config.py` に、v2 仕様で要求される設定値（除外 TLD, 除外パスパターン, スコアリング重み, ヒューリスティック用キーワード）を定数として追加する。
    -   **観測項目**: `config.py` に `EXCLUDE_TLDS = {".org"}` や `VENDOR_KEYWORDS = ["価格", "料金"...]` といった定数が定義されていること。
    -   **テスト手順**: なし（静的設定）。

## Phase 2: 超早期フィルタの実装 (Pre-HTTP Filtering)

-   [ ] T002 `src/filter.py` に `pre_http_filter(urls: list[str]) -> list[str]` 関数を新規作成する。
    -   **観測項目**: 指定されたシグネチャを持つ関数が `filter.py` 内に存在すること。
    -   **テスト手順**: ダミーの URL リストを渡し、フィルタリング後のリストが返ることを確認。
-   [ ] T003 `pre_http_filter` 内に **HTTPS_ONLY** のルールを実装する。
    -   **観測項目**: `http://` で始まる URL が除外されるロジックが追加されていること。
    -   **テスト手順**: `tests/test_filter.py` を作成し、`http://` と `https://` が混在したリストを与え、`https://` のみ残ることを確認するテストを追加。
-   [ ] T004 `pre_http_filter` 内に **ドメインフィルタ** (`.org` 除外, `.com` の条件付き許可) を実装する。
    -   **観測項目**: `.org` で終わる URL が除外され、`.com` は `FREE_INCLUDE_COM_IN_JA` 環境変数を参照して処理されること。
    -   **テスト手順**: `.jp`, `.org`, `.com` の URL を含むリストで、期待通りにフィルタされるかテストを追加。
-   [ ] T005 `pre_http_filter` 内に **パターンベース除外** (添付拡張子, ユーティリティパス) を実装する。
    -   **観測項目**: `config.py` の除外パターンリストに基づき、URL が除外されること。
    -   **テスト手順**: `example.com/path/to/file.pdf` や `example.com/login` といった URL が除外されるテストを追加。
-   [ ] T006 `pre_http_filter` 内に **日本語ヒューリスティクス** を実装する。
    -   **観測項目**: `.jp` TLD を持たない URL が、パスまたはドメインに日本語文字を含まない場合に除外されること。
    -   **テスト手順**: 日本語を含むパス、含まないパス、`.jp` ドメインの URL でテストを実施。
-   [ ] T007 `src/pipeline.py` の `discover` ステップの直後に `pre_http_filter` を組み込む。
    -   **観測項目**: `searchers.py` から返された URL リストが `filter.py` の `pre_http_filter` に渡されていること。
    -   **テスト手順**: `pipeline.py` のログ出力等で、フィルタによって URL 数が減少することを確認。

## Phase 3: コンテンツベースフィルタの実装 (Post-HTTP Filtering)

-   [ ] T008 `src/filter.py` に `post_http_filter(page_content: str, url: str) -> tuple[bool, str]` を新規作成する。戻り値は `(is_excluded, reason)`。
    -   **観測項目**: 指定されたシグネチャを持つ関数が `filter.py` 内に存在すること。
    -   **テスト手順**: ダミーの HTML コンテンツを渡し、`False, ""` が返ることを確認。
-   [ ] T009 `post_http_filter` 内に **ベンダーサイト判定** ロジックを実装する。
    -   **観測項目**: `tasks.md` のヒューリスティクス（ナビゲーションのキーワード、特定パスなど）に基づき判定が行われること。
    -   **テスト手順**: ベンダーサイトの典型的な HTML を食わせ、`(True, "VENDOR")` が返るテストを `tests/test_filter.py` に追加。
-   [ ] T010 `post_http_filter` 内に **ニュースサイト判定** ロジックを実装する。
    -   **観測項目**: `tasks.md` のヒューリスティクス（`og:type`, 日付パターンなど）に基づき判定が行われること。
    -   **テスト手順**: ニュース記事の典型的な HTML を食わせ、`(True, "NEWS")` が返るテストを追加。
-   [ ] T011 `post_http_filter` 内に **資料置き場判定** ロジックを実装する。
    -   **観測項目**: `tasks.md` のヒューリスティクス（ファイルリンク数、本文の薄さ）に基づき判定が行われること。
    -   **テスト手順**: PDF へのリンクが多数あるページの HTML を食わせ、`(True, "DOC_REPO")` が返るテストを追加。
-   [ ] T012 `src/sheets.py` に `write_exclusion_log(excluded_items: list[dict])` を新規作成する。
    -   **観測項目**: 「除外ログ」シートに URL, 理由, タイムスタンプ等を追記する Google Sheets API 呼び出しが実装されていること。
    -   **テスト手順**: ダミーの除外アイテムリストを渡し、実際にシートに書き込まれるか手動で確認。
-   [ ] T013 `src/pipeline.py` の `fetch` ステップの後に `post_http_filter` を組み込み、除外対象を `write_exclusion_log` に渡す。
    -   **観測項目**: `fetcher.py` から取得したコンテンツが `post_http_filter` に渡され、戻り値に応じて `sheets.py` のログ関数が呼ばれること。
    -   **テスト手順**: E2E テストで、意図的にベンダーサイトなどをクロールさせ、「除外ログ」シートに記録が残ることを確認。

## Phase 4: SERPライクスコアリングの実装 (Scoring)

-   [ ] T014 `src/scorer.py` の `calculate_score` を `calculate_serp_like_score` にリネームし、`tasks.md` のスコア計算式を実装する。
    -   **観測項目**: `scorer.py` 内の関数が、TITLE_BM25, URL_TOKENS 等の複数のサブスコアを計算し、重み付け加算していること。
    -   **テスト手順**: `tests/test_scorer.py` を作成し、固定の HTML とクエリに対して、期待されるスコア（範囲）が計算されることを確認。
-   [ ] T015 `calculate_serp_like_score` に `filter.py` からのペナルティ（`vendor_penalty` 等）を減算するロジックを組み込む。
    -   **観測項目**: `post_http_filter` で除外されなかったがペナルティ対象のページのスコアが、計算式通りに減算されていること。
    -   **テスト手順**: ベンダーサイトに近いが除外はされないページのスコアが、ペナルティ分低くなることをテストで確認。
-   [ ] T016 `src/pipeline.py` を修正し、新しいスコアでソートし、`TopK/クエリ` と `1ドメイン上限` を適用する。
    -   **観測項目**: スコアリング後のリストがドメインでグループ化され、各ドメインから最もスコアの高い URL のみが選出されていること。
    -   **テスト手順**: 同一ドメインから複数の URL が含まれるリストを処理させ、最終的に各ドメイン1つに絞られることを確認。

## Phase 5: 最終確認 (Finalization)

-   [ ] T017 20クエリ程度で E2E テストを実行し、AC-005 の時間基準（3h/200クエリ）から大きく外れないことを確認する。
    -   **観測項目**: ログに出力される処理時間が、クエリ数あたり約 0.9 分（54秒）以内に収まっていること。
-   [ ] T018 「候補URL」「除外ログ」シートの出力結果が、仕様と実装に照らして妥当であることを目視で確認する。
    -   **観測項目**: 明らかなノイズ（ログインページ、PDF 等）が候補URLに含まれておらず、それらが除外ログに記録されていること。
-   [ ] T019 デバッグ目的で追加した `print` 文や、不要なコメントアウトをすべて削除する。
    -   **観測項目**: コードベースにデバッグ用の出力が残っていないこと。
    -   **テスト手順**: なし（コードレビュー）。